import groovy.json.JsonSlurperClassic

def build_id
def build_zip
def build_tar
def build_maven
def authProps = [
  'requestProperties' : [
    'Authorization': "Basic ${'mw-build-user:da2011a51dc4a01e9001dd68149225ca'.bytes.encodeBase64()}".toString()
  ]
]

node () {
    stage('get stagger info') {
        checkout scm
        sh "sh ./scripts/getamq.sh"
        def props = readProperties  file:'build.properties'
        build_id= props['BUILDID']
        build_zip= props['BUILDZIP']
        build_tar= props['BUILDTAR']
        build_maven= props['BUILDMAVEN']
        echo "build_id=${build_id}"
        echo "build_zip=${build_zip}"
        echo "build_tar=${build_tar}"
        echo "build_maven=${build_maven}"
    }
    stage ('build eap') {
        def eap = build(
        job: 'early-testing-messaging-prepare',
        parameters: [
            [ $class: 'StringParameterValue', name: 'EAP_REPO', value: 'https://github.com/ehsavoie/wildfly/' ],
            [ $class: 'StringParameterValue', name: 'EAP_BRANCH', value: 'messaging_upstream' ],
            [ $class: 'StringParameterValue', name: 'ARTEMIS_ZIP_URL', value: build_zip]
        ],
        propagate: false
        )
        if (eap.result != 'SUCCESS') {
            throw new Exception("EAP build job failed.")
        }
        eapZipUrl = "${eap.absoluteUrl}/artifact/jboss-eap.zip"
        clientsVersion = "${eap.absoluteUrl}/artifact/clients-version.txt".toURL().getText(authProps).trim()

        steps {
            parallel (
                "early testing messaging tests ssl" : {
                    build(
                        job: 'early-testing-messaging-weekly-tests-ssl',
                        parameters: [
                        [ $class: 'StringParameterValue', name: 'EAP_ZIP_URL', value: eapZipUrl ],
                        [ $class: 'StringParameterValue', name: 'EAP_VERSION', value: clientsVersion ],
                        [ $class: 'StringParameterValue', name: 'TESTSUITE_REPO', value: 'git@bitbucket.org:msgqe/eap-testsuite-mirror.git' ],
                        [ $class: 'StringParameterValue', name: 'TESTSUITE_BRANCH', value: 'amq-baseline-pm' ]
                        ],
                        propagate: false
                    )
                },
                "early testing messaging tests huge messages" : {
                    build(
                        job: 'early-testing-messaging-weekly-tests-huge-messages',
                        parameters: [
                        [ $class: 'StringParameterValue', name: 'EAP_ZIP_URL', value: eapZipUrl ],
                        [ $class: 'StringParameterValue', name: 'EAP_VERSION', value: clientsVersion ],
                        [ $class: 'StringParameterValue', name: 'TESTSUITE_REPO', value: 'git@bitbucket.org:msgqe/eap-testsuite-mirror.git' ],
                        [ $class: 'StringParameterValue', name: 'TESTSUITE_BRANCH', value: 'amq-baseline-pm' ]
                        ],
                        propagate: false
                    )
                }
            )
        }
    }
}